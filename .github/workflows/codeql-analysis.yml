name: "CodeQL"

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        language: [ 'java', 'javascript' ]
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v1
      with:
        languages: ${{ matrix.language }}
    - name: Setup Node
      if: ${{ matrix.language == 'java' }}
      uses: actions/setup-node@v2.1.2
    - name: Setup Angular
      if: ${{ matrix.language == 'java' }}
      run: npm install @angular/cli
    - name: Setup Ionic
      if: ${{ matrix.language == 'java' }}
      run: npm install @ionic/cli
    - name: NPM Install
      if: ${{ matrix.language == 'java' }}
      run: npm install
    - name: Set Release Name Variable
      run: echo "RELEASE_NAME=CODEQL" >> $GITHUB_ENV
    - name: Set Release Track Variable
      run: echo "RELEASE_TRACK=CODEQL" >> $GITHUB_ENV
    - name: Setup Environment File
      run: sed -i 's/};/versionCode:${{ github.run_number }},\n versionName:"${{ env.RELEASE_NAME }}",\n track:"${{ env.RELEASE_TRACK }}"\n};/g' src/environments/environment.prod.ts
    - name: Check Environment File
      run: cat src/environments/environment.prod.ts
    - name: Fake Launches
      run: mkdir src/app/data && echo '[]' > src/app/data/launches.json
    - name: Build with Ionic
      if: ${{ matrix.language == 'java' }}
      run: npm run build:prod
    - name: Capacitor Update
      if: ${{ matrix.language == 'java' }}
      run: npx cap update android
    - name: Capacitor Copy
      if: ${{ matrix.language == 'java' }}
      run: npx cap copy
    - name: Setup JDK 1.8
      if: ${{ matrix.language == 'java' }}
      uses: actions/setup-java@v1
      with:
        java-version: 1.8
    - name: Build with Gradle
      if: ${{ matrix.language == 'java' }}
      run: cd android && chmod +x gradlew && ./gradlew bundleRelease        
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v1