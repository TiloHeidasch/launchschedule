name: Merge Masterdata

on:
  schedule:
    # * is a special character in YAML so you have to quote this string
    - cron: '0 12 * * *'
  workflow_dispatch:

jobs:
  merge:
    name: Merge Master Data
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          ref: masterdata
      - name: Create data dirs
        run: mkdir src && mkdir src/app && mkdir src/app/data
      - name: Moves Data
        run: mv *.json src/app/data
      - name: Download masterdata merge script
        run: curl https://raw.githubusercontent.com/TiloHeidasch/launchschedule/master/scripts/masterdata/merge.ts > merge.ts
      - name: Download launch merge script
        run: curl https://raw.githubusercontent.com/TiloHeidasch/launchschedule/master/scripts/mergeLaunches.ts > mergeLaunches.ts
      - name: Create script dirs
        run: mkdir scripts && mkdir scripts/masterdata
      - name: Move scripts
        run: mv merge.ts scripts/masterdata/ && mv mergeLaunches.ts scripts/
      - name: Merge Agencies
        run: node scripts/masterdata/merge.ts agencies 500 500
      - name: Merge Astronauts
        run: node scripts/masterdata/merge.ts astronauts 1000 500
      - name: Merge Launches
        run: node scripts/mergeLaunches.ts 7000 500
      - name: Merge Locations
        run: node scripts/masterdata/merge.ts locations 500 500
      - name: Merge Pads
        run: node scripts/masterdata/merge.ts pads 500 500
      - name: Merge Previous Events
        run: node scripts/masterdata/merge.ts previousevents 500 500
      - name: Merge Previous Launches
        run: node scripts/masterdata/merge.ts previouslaunches 6500 500
      - name: Merge Rockets
        run: node scripts/masterdata/merge.ts rockets 500 500
      - name: Merge Spacecrafts
        run: node scripts/masterdata/merge.ts spacecrafts 500 500
      - name: Merge Spacestations
        run: node scripts/masterdata/merge.ts spacestations 500 500
      - name: Safe MasterData Artifact
        uses: actions/upload-artifact@v2.2.3
        with:
          name: masterdataIN
          path: src/app/data/
  images:
    name: Pre-Load Images
    runs-on: ubuntu-latest
    needs: merge
    steps:
      - name: Download Masterdata
        uses: actions/download-artifact@v2.0.9
        with:
          name: masterdataIN
          path: ./
      - name: Create data dirs
        run: mkdir src && mkdir src/app && mkdir src/app/dataIN && mkdir src/app/data && mkdir src/assets
      - name: Moves Data
        run: mv *.json src/app/dataIN
      - name: Download image script
        run: curl https://raw.githubusercontent.com/TiloHeidasch/launchschedule/master/scripts/fetchImages.ts > fetchImages.ts
      - name: Create script dirs
        run: mkdir scripts
      - name: Move scripts
        run: mv fetchImages.ts scripts/
      - name: Download Images
        run: wget https://github.com/TiloHeidasch/launchschedule/archive/refs/heads/images.zip
      - name: Unzip Images
        uses: TonyBogdanov/zip@1.0
        with:
          args: unzip -qq ./images.zip -d ./src/assets/
      - name: Copy Images
        run: sudo cp -r ./src/assets/launchschedule-images/* ./src/assets/
      - name: Delete Images
        run: sudo rm -r ./src/assets/launchschedule-images
      - name: Install Sync Request
        run: npm install sync-request
      - name: Agency Images
        run: node scripts/fetchImages.ts agency src/app/dataIN/agencies.json src/app/data/agencies.json 100 image_url nation_url logo_url
      - name: Astronaut Images
        run: node scripts/fetchImages.ts astronaut src/app/dataIN/astronauts.json src/app/data/astronauts.json 100 profile_image_thumbnail
      - name: Location Images
        run: node scripts/fetchImages.ts location src/app/dataIN/locations.json src/app/data/locations.json 100 map_image
      - name: Pad Images
        run: node scripts/fetchImages.ts pad src/app/dataIN/pads.json src/app/data/pads.json 100 map_image
      - name: Rocket Images
        run: node scripts/fetchImages.ts rocket src/app/dataIN/rockets.json src/app/data/rockets.json 100 image_url
      - name: Spacecraft Images
        run: node scripts/fetchImages.ts spacecraft src/app/dataIN/spacecrafts.json src/app/data/spacecrafts.json 100 image_url
      - name: Spacestation Images
        run: node scripts/fetchImages.ts spacestation src/app/dataIN/spacestations.json src/app/data/spacestations.json 100 image_url
      - name: Safe MasterData Artifact
        uses: actions/upload-artifact@v2.2.3
        with:
          name: masterdataOUT
          path: src/app/data
      - name: Safe Images Artifact
        uses: actions/upload-artifact@v2.2.3
        with:
          name: images
          path: src/assets
  # uploadmasterdata:
  #   name: Upload Masterdata to branch
  #   runs-on: ubuntu-latest
  #   needs: images
  #   steps:
  #     - name: Download Masterdata
  #       uses: actions/download-artifact@v2.0.9
  #       with:
  #         name: masterdataOUT
  #         path: ./
  #     - name: Push to Masterdata branch
  #       uses: crazy-max/ghaction-github-pages@v2.3.0
  #       with:
  #         build_dir: ./
  #         target_branch: masterdata
  #         commit_message: 'Merges Masterdata'
  #       env:
  #         GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  uploadimages:
    name: Upload Images to branch
    runs-on: ubuntu-latest
    needs: images
    steps:
      - name: Download Images
        uses: actions/download-artifact@v2.0.9
        with:
          name: images
          path: ./
      - name: Push to Images branch
        uses: crazy-max/ghaction-github-pages@v2.3.0
        with:
          build_dir: ./
          target_branch: images
          commit_message: 'Updates Images'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}